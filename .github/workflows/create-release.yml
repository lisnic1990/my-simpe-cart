name: Create OCMOD Release

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'install.xml'
      - 'upload/**'

permissions:
  contents: write

jobs:
  create-ocmod-archive:
    name: Build OCMOD Archive
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Verify OCMOD structure
        run: |
          if [ ! -f "install.xml" ]; then
            echo "Error: install.xml not found!"
            exit 1
          fi
          
          if [ ! -d "upload" ]; then
            echo "Error: upload directory not found!"
            exit 1
          fi
          
          echo "OCMOD structure verified successfully"
          
      - name: Parse install.xml
        id: ocmod
        run: |
          # Установка xmlstarlet для парсинга XML
          sudo apt-get update -qq
          sudo apt-get install -y -qq xmlstarlet
          
          # Извлечение версии
          VERSION=$(xmlstarlet sel -t -v "//version" install.xml | xargs)
          if [ -z "$VERSION" ]; then
            echo "Error: Version not found in install.xml"
            exit 1
          fi
          
          # Извлечение кода модуля (приоритет: code, затем id)
          MODULE_CODE=$(xmlstarlet sel -t -v "//code" install.xml 2>/dev/null | xargs)
          if [ -z "$MODULE_CODE" ]; then
            MODULE_CODE=$(xmlstarlet sel -t -v "//id" install.xml 2>/dev/null | xargs)
          fi
          
          # Если код не найден, используем имя
          if [ -z "$MODULE_CODE" ]; then
            MODULE_NAME=$(xmlstarlet sel -t -v "//name" install.xml | xargs)
            # Преобразуем имя в snake_case
            MODULE_CODE=$(echo "$MODULE_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | tr -cd '[:alnum:]_')
          fi
          
          if [ -z "$MODULE_CODE" ]; then
            echo "Error: Cannot determine module code from install.xml"
            exit 1
          fi
          
          echo "Module Code: $MODULE_CODE"
          echo "Version: $VERSION"
          
          echo "module_code=$MODULE_CODE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Get commit info
        id: commit
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          
      - name: Create OCMOD archive
        run: |
          ARCHIVE_NAME="${{ steps.ocmod.outputs.module_code }}_v${{ steps.ocmod.outputs.version }}.ocmod.zip"
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
          
          # Создаем архив с максимальным сжатием только из upload/ и install.xml
          zip -r -9 "$ARCHIVE_NAME" upload install.xml
          
          if [ ! -f "$ARCHIVE_NAME" ]; then
            echo "Error: Archive creation failed"
            exit 1
          fi
          
          echo "OCMOD archive created successfully:"
          ls -lh "$ARCHIVE_NAME"
          
          # Вывод содержимого архива для проверки
          echo ""
          echo "Archive contents:"
          unzip -l "$ARCHIVE_NAME"
          
      - name: Create release info
        run: |
          echo "OCMOD Release Package" > RELEASE_INFO.txt
          echo "=====================" >> RELEASE_INFO.txt
          echo "" >> RELEASE_INFO.txt
          echo "Module: ${{ steps.ocmod.outputs.module_code }}" >> RELEASE_INFO.txt
          echo "Version: ${{ steps.ocmod.outputs.version }}" >> RELEASE_INFO.txt
          echo "Archive: $ARCHIVE_NAME" >> RELEASE_INFO.txt
          echo "" >> RELEASE_INFO.txt
          echo "Build Information:" >> RELEASE_INFO.txt
          echo "Branch: ${{ steps.commit.outputs.branch }}" >> RELEASE_INFO.txt
          echo "Commit: ${{ github.sha }}" >> RELEASE_INFO.txt
          echo "Short SHA: ${{ steps.commit.outputs.sha_short }}" >> RELEASE_INFO.txt
          echo "Author: ${{ github.actor }}" >> RELEASE_INFO.txt
          echo "Date: ${{ steps.commit.outputs.date }}" >> RELEASE_INFO.txt
          echo "Message: ${{ github.event.head_commit.message }}" >> RELEASE_INFO.txt
          
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: release
          path: release-branch
          
      - name: Copy files to release branch
        run: |
          cp "$ARCHIVE_NAME" release-branch/
          cp RELEASE_INFO.txt release-branch/
          cd release-branch
          
          # Создаем latest.ocmod.zip (всегда последняя версия)
          cp "$ARCHIVE_NAME" latest.ocmod.zip
          
          # Создаем манифест
          echo "{" > MANIFEST.json
          echo "  \"latest\": {" >> MANIFEST.json
          echo "    \"filename\": \"$ARCHIVE_NAME\"," >> MANIFEST.json
          echo "    \"module_code\": \"${{ steps.ocmod.outputs.module_code }}\"," >> MANIFEST.json
          echo "    \"version\": \"${{ steps.ocmod.outputs.version }}\"," >> MANIFEST.json
          echo "    \"branch\": \"${{ steps.commit.outputs.branch }}\"," >> MANIFEST.json
          echo "    \"commit\": \"${{ github.sha }}\"," >> MANIFEST.json
          echo "    \"short_sha\": \"${{ steps.commit.outputs.sha_short }}\"," >> MANIFEST.json
          echo "    \"timestamp\": \"${{ steps.commit.outputs.timestamp }}\"," >> MANIFEST.json
          echo "    \"date\": \"${{ steps.commit.outputs.date }}\"," >> MANIFEST.json
          echo "    \"author\": \"${{ github.actor }}\"," >> MANIFEST.json
          echo "    \"message\": \"${{ github.event.head_commit.message }}\"" >> MANIFEST.json
          echo "  }" >> MANIFEST.json
          echo "}" >> MANIFEST.json
          
          # Создаем контрольные суммы
          sha256sum "$ARCHIVE_NAME" > "$ARCHIVE_NAME.sha256"
          sha256sum latest.ocmod.zip > latest.ocmod.zip.sha256
          md5sum "$ARCHIVE_NAME" > "$ARCHIVE_NAME.md5"
          md5sum latest.ocmod.zip > latest.ocmod.zip.md5
          
      - name: Commit and push to release
        working-directory: release-branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add .
          git commit -m "OCMOD Release: ${{ steps.ocmod.outputs.module_code }} v${{ steps.ocmod.outputs.version }} (${{ steps.commit.outputs.sha_short }})"
          git push origin release
          
      - name: Create deployment summary
        run: |
          echo "## OCMOD Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Module Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Module Code:** \`${{ steps.ocmod.outputs.module_code }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** \`${{ steps.ocmod.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Archive:** \`$ARCHIVE_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.commit.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ steps.commit.outputs.sha_short }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** ${{ steps.commit.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Links" >> $GITHUB_STEP_SUMMARY
          echo "- Latest version: https://github.com/${{ github.repository }}/raw/release/latest.ocmod.zip" >> $GITHUB_STEP_SUMMARY
          echo "- This version: https://github.com/${{ github.repository }}/raw/release/$ARCHIVE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the .ocmod.zip file" >> $GITHUB_STEP_SUMMARY
          echo "2. Go to Extensions → Installer in OcStore admin panel" >> $GITHUB_STEP_SUMMARY
          echo "3. Upload the archive" >> $GITHUB_STEP_SUMMARY
          echo "4. Go to Extensions → Modifications and click Refresh" >> $GITHUB_STEP_SUMMARY
