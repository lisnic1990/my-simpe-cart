{{ header }}
<style>
/* Hide sidebar menu on checkout page */
#checkout-checkout .aside-menu,
#checkout-checkout #column-left,
#checkout-checkout #column-right,
#checkout-checkout .sidebar-menu,
#checkout-checkout .account-menu,
.simple-checkout-page #column-left,
.simple-checkout-page #column-right,
.simple-checkout-page .aside-menu {
  display: none !important;
}

/* Simple Checkout Lite - Unishop2 Free Theme Styles */
.simple-checkout-wrapper {
  margin-bottom: 30px;
}

.checkout-section {
  background: #fff;
  border: 1px solid #e5e5e5;
  border-radius: 4px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.checkout-section-header {
  background: #f8f8f8;
  padding: 15px 20px;
  border-bottom: 1px solid #e5e5e5;
  border-radius: 4px 4px 0 0;
}

.checkout-section-icon {
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  text-align: center;
  background: #4CAF50;
  color: #fff;
  border-radius: 50%;
  margin-right: 10px;
  font-size: 14px;
}

.checkout-section-title {
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.checkout-section-body {
  padding: 20px;
}

/* Form row/col flex layout */
.form-row {
  display: flex;
  flex-wrap: wrap;
  margin-left: -10px;
  margin-right: -10px;
  margin-bottom: 5px;
}

.form-col {
  flex: 1 1 calc(50% - 20px);
  min-width: 200px;
  padding-left: 10px;
  padding-right: 10px;
  box-sizing: border-box;
}

.form-col-full {
  flex: 1 1 100%;
}

@media (max-width: 576px) {
  .form-col {
    flex: 1 1 100%;
  }
}

.checkout-section .form-group {
  margin-bottom: 15px;
}

.checkout-section .form-group label,
.checkout-section .control-label {
  font-weight: 500;
  color: #555;
  margin-bottom: 5px;
  display: block;
  text-align: left;
  float: none;
  width: 100%;
  padding-top: 0;
}

.checkout-section .form-control {
  border-radius: 4px;
  border: 1px solid #ddd;
  padding: 10px 15px;
  height: auto;
  min-height: 44px;
  width: 100%;
  box-sizing: border-box;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.checkout-section .form-control:focus {
  border-color: #4CAF50;
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}

.checkout-section .form-group.has-error .form-control {
  border-color: #f44336;
}

.checkout-section .form-group.has-error .field-error,
.checkout-section .text-danger {
  color: #f44336;
  font-size: 12px;
  margin-top: 5px;
}

.checkout-section .required label:before {
  content: '* ';
  color: #f44336;
}

/* Custom checkbox for unishop2 */
.custom-checkbox label {
  display: flex;
  align-items: flex-start;
  cursor: pointer;
  font-weight: normal;
  line-height: 1.4;
}

.custom-checkbox input[type="checkbox"] {
  display: none;
}

.custom-checkbox .checkbox-icon {
  width: 20px;
  height: 20px;
  min-width: 20px;
  border: 2px solid #ddd;
  border-radius: 3px;
  margin-right: 10px;
  margin-top: 2px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}

.custom-checkbox input[type="checkbox"]:checked + .checkbox-icon {
  background: #4CAF50;
  border-color: #4CAF50;
}

.custom-checkbox input[type="checkbox"]:checked + .checkbox-icon:after {
  content: '\f00c';
  font-family: FontAwesome;
  color: #fff;
  font-size: 12px;
}

/* Agreement text */
.checkout-agree .custom-checkbox label {
  align-items: flex-start;
}

.checkout-agree .checkbox-text {
  flex: 1;
}

.checkout-agree .checkbox-text a {
  white-space: nowrap;
}

/* Shipping and Payment methods */
.shipping-methods-list .radio,
.payment-methods-list .radio {
  margin: 0;
  padding: 12px 15px;
  border: 1px solid #eee;
  border-radius: 4px;
  margin-bottom: 10px;
  transition: all 0.2s;
}

.shipping-methods-list .radio:hover,
.payment-methods-list .radio:hover {
  border-color: #4CAF50;
  background: #f9fff9;
}

.shipping-methods-list .radio label,
.payment-methods-list .radio label {
  font-weight: normal;
  cursor: pointer;
  display: block;
}

.shipping-methods-list .radio input[type="radio"],
.payment-methods-list .radio input[type="radio"] {
  margin-right: 10px;
}

.loading-placeholder {
  text-align: center;
  padding: 20px;
  color: #999;
}

/* Sidebar */
.checkout-sidebar {
  position: sticky;
  top: 20px;
}

.table-totals {
  margin-bottom: 0;
}

.table-totals td {
  padding: 10px 0;
  border-top: 1px solid #eee;
}

.table-totals tr:first-child td {
  border-top: none;
}

.table-totals tr:last-child td {
  font-size: 18px;
  font-weight: 600;
  color: #4CAF50;
}

.checkout-agree {
  padding: 15px;
  background: #f8f8f8;
  border-radius: 4px;
  margin-bottom: 15px;
}

.btn-checkout {
  background: #4CAF50;
  border-color: #4CAF50;
  font-size: 16px;
  padding: 15px 30px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: all 0.3s;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  text-align: center;
  width: 100%;
}

.btn-checkout:hover,
.btn-checkout:focus {
  background: #43a047;
  border-color: #43a047;
  color: #fff;
}

.btn-checkout:disabled {
  background: #ccc;
  border-color: #ccc;
}

/* Fix select fields (Country, Zone) */
.checkout-section select.form-control {
  height: auto;
  min-height: 46px;
  padding: 10px 15px;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 15px center;
  padding-right: 40px;
}

/* Fix input fields alignment */
.checkout-section input.form-control,
.checkout-section select.form-control,
.checkout-section textarea.form-control {
  width: 100%;
  box-sizing: border-box;
}

/* Fix telephone field */
#input-telephone {
  width: 100%;
}

/* Alert styles */
.checkout-section .alert {
  margin-bottom: 0;
  border-radius: 4px;
}

/* Checkout products list */
.checkout-products {
  margin-bottom: 10px;
}

.checkout-product {
  display: flex;
  align-items: flex-start;
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
}

.checkout-product:last-child {
  border-bottom: none;
}

.checkout-product-image {
  flex-shrink: 0;
  width: 60px;
  margin-right: 12px;
}

.checkout-product-image img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 4px;
  border: 1px solid #eee;
}

.checkout-product-info {
  flex: 1;
  min-width: 0;
}

.checkout-product-name {
  font-weight: 500;
  font-size: 13px;
  line-height: 1.3;
  margin-bottom: 3px;
}

.checkout-product-name a {
  color: #333;
  text-decoration: none;
}

.checkout-product-name a:hover {
  color: #4CAF50;
}

.checkout-product-options {
  font-size: 11px;
  color: #888;
  margin-bottom: 3px;
}

.checkout-product-qty {
  font-size: 12px;
  color: #666;
}

.checkout-product-total {
  flex-shrink: 0;
  font-weight: 600;
  font-size: 13px;
  color: #333;
  margin-left: 10px;
  text-align: right;
}

/* Mobile responsive */
@media (max-width: 991px) {
  .checkout-sidebar {
    position: static;
    margin-top: 20px;
  }
}

@media (max-width: 767px) {
  .checkout-section-body {
    padding: 15px;
  }

  .checkout-section-header {
    padding: 12px 15px;
  }

  .checkout-section-title {
    font-size: 14px;
  }

  .btn-checkout {
    font-size: 14px;
    padding: 12px 20px;
  }
}
</style>

<div id="checkout-checkout" class="container simple-checkout-page">
  <ul class="breadcrumb">
    {% for breadcrumb in breadcrumbs %}
    <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
    {% endfor %}
  </ul>
  <div class="row">
    <div id="content" class="col-sm-12">{{ content_top }}
      <h1 class="heading-title">{{ heading_title }}</h1>

      <div id="simple-checkout-lite" class="simple-checkout-wrapper">
        <form id="simple-checkout-form" class="form-horizontal">

          {# Unishop2 styled checkout sections #}
          <div class="row">
            <div class="col-md-8">

              {# Customer Information - Unishop2 style #}
              <div class="checkout-section checkout-customer">
                <div class="checkout-section-header">
                  <span class="checkout-section-icon"><i class="fa fa-user"></i></span>
                  <span class="checkout-section-title">{{ text_customer_info }}</span>
                </div>
                <div class="checkout-section-body">
                  {# Row 1: First Name + Last Name #}
                  <div class="form-row">
                    {# First Name #}
                    {% if fields.firstname != 'hidden' %}
                    <div class="form-col">
                      <div class="form-group{% if fields.firstname == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-firstname">{{ entry_firstname }}</label>
                        <input type="text" name="firstname" value="{{ customer_firstname }}" placeholder="{{ entry_firstname }}" id="input-firstname" class="form-control" />
                      </div>
                    </div>
                    {% endif %}

                    {# Last Name #}
                    {% if fields.lastname != 'hidden' %}
                    <div class="form-col">
                      <div class="form-group{% if fields.lastname == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-lastname">{{ entry_lastname }}</label>
                        <input type="text" name="lastname" value="{{ customer_lastname }}" placeholder="{{ entry_lastname }}" id="input-lastname" class="form-control" />
                      </div>
                    </div>
                    {% endif %}
                  </div>

                  {# Row 2: Email + Telephone #}
                  <div class="form-row">
                    {# Email #}
                    {% if fields.email != 'hidden' %}
                    <div class="form-col">
                      <div class="form-group{% if fields.email == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-email">{{ entry_email }}</label>
                        <input type="email" name="email" value="{{ customer_email }}" placeholder="{{ entry_email }}" id="input-email" class="form-control" />
                      </div>
                    </div>
                    {% endif %}

                    {# Telephone #}
                    {% if fields.telephone != 'hidden' %}
                    <div class="form-col">
                      <div class="form-group{% if fields.telephone == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-telephone">{{ entry_telephone }}</label>
                        <input type="tel" name="telephone" value="{{ customer_telephone }}" placeholder="{{ entry_telephone }}" id="input-telephone" class="form-control" />
                      </div>
                    </div>
                    {% endif %}
                  </div>

                  {# Row 3: Company (if visible) #}
                  {% if fields.company != 'hidden' %}
                  <div class="form-row">
                    <div class="form-col form-col-full">
                      <div class="form-group{% if fields.company == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-company">{{ entry_company }}</label>
                        <input type="text" name="company" value="{{ customer_company }}" placeholder="{{ entry_company }}" id="input-company" class="form-control" />
                      </div>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>

              {# Address Section - Unishop2 style #}
              {% if shipping_required or fields.address_1 != 'hidden' or fields.city != 'hidden' or fields.country != 'hidden' %}
              <div class="checkout-section checkout-address">
                <div class="checkout-section-header">
                  <span class="checkout-section-icon"><i class="fa fa-map-marker"></i></span>
                  <span class="checkout-section-title">{{ text_shipping_address }}</span>
                </div>
                <div class="checkout-section-body">
                  {# Row 1: Address 1 #}
                  {% if fields.address_1 != 'hidden' %}
                  <div class="form-row">
                    <div class="form-col form-col-full">
                      <div class="form-group{% if fields.address_1 == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-address-1">{{ entry_address_1 }}</label>
                        <input type="text" name="address_1" value="{{ customer_address_1 }}" placeholder="{{ entry_address_1 }}" id="input-address-1" class="form-control" />
                      </div>
                    </div>
                  </div>
                  {% endif %}

                  {# Row 2: Address 2 #}
                  {% if fields.address_2 != 'hidden' %}
                  <div class="form-row">
                    <div class="form-col form-col-full">
                      <div class="form-group{% if fields.address_2 == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-address-2">{{ entry_address_2 }}</label>
                        <input type="text" name="address_2" value="{{ customer_address_2 }}" placeholder="{{ entry_address_2 }}" id="input-address-2" class="form-control" />
                      </div>
                    </div>
                  </div>
                  {% endif %}

                  {# Row 3: City + Postcode #}
                  <div class="form-row">
                    {% if fields.city != 'hidden' %}
                    <div class="form-col">
                      <div class="form-group{% if fields.city == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-city">{{ entry_city }}</label>
                        <input type="text" name="city" value="{{ customer_city }}" placeholder="{{ entry_city }}" id="input-city" class="form-control" />
                      </div>
                    </div>
                    {% endif %}

                    {% if fields.postcode != 'hidden' %}
                    <div class="form-col">
                      <div class="form-group{% if fields.postcode == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-postcode">{{ entry_postcode }}</label>
                        <input type="text" name="postcode" value="{{ customer_postcode }}" placeholder="{{ entry_postcode }}" id="input-postcode" class="form-control" />
                      </div>
                    </div>
                    {% endif %}
                  </div>

                  {# Row 4: Country + Zone #}
                  <div class="form-row">
                    {% if fields.country != 'hidden' %}
                    <div class="form-col">
                      <div class="form-group{% if fields.country == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-country">{{ entry_country }}</label>
                        <select name="country_id" id="input-country" class="form-control">
                          <option value="">{{ entry_country }}</option>
                          {% for country in countries %}
                          {% if country.country_id == customer_country_id %}
                          <option value="{{ country.country_id }}" selected="selected">{{ country.name }}</option>
                          {% else %}
                          <option value="{{ country.country_id }}">{{ country.name }}</option>
                          {% endif %}
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                    {% endif %}

                    {% if fields.zone != 'hidden' %}
                    <div class="form-col">
                      <div class="form-group{% if fields.zone == 'required' %} required{% endif %}">
                        <label class="control-label" for="input-zone">{{ entry_zone }}</label>
                        <select name="zone_id" id="input-zone" class="form-control" data-zone-id="{{ customer_zone_id }}">
                        </select>
                      </div>
                    </div>
                    {% endif %}
                  </div>

                  {# Same address checkbox #}
                  {% if show_shipping_address %}
                  <div class="form-group" style="margin-top: 15px;">
                    <div class="checkbox custom-checkbox">
                      <label>
                        <input type="checkbox" name="shipping_address" value="1" checked="checked" />
                        <span class="checkbox-icon"></span>
                        <span class="checkbox-text">{{ entry_same_address }}</span>
                      </label>
                    </div>
                  </div>
                  {% else %}
                  <input type="hidden" name="shipping_address" value="1" />
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {# Shipping Method - Unishop2 style #}
              {% if shipping_required and show_shipping_method %}
              <div class="checkout-section checkout-shipping">
                <div class="checkout-section-header">
                  <span class="checkout-section-icon"><i class="fa fa-truck"></i></span>
                  <span class="checkout-section-title">{{ text_shipping_method }}</span>
                </div>
                <div class="checkout-section-body">
                  <div id="shipping-methods" class="shipping-methods-list">
                    <div class="loading-placeholder">
                      <i class="fa fa-spinner fa-spin"></i> {{ text_loading }}
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}

              {# Payment Method - Unishop2 style #}
              {% if show_payment_method %}
              <div class="checkout-section checkout-payment">
                <div class="checkout-section-header">
                  <span class="checkout-section-icon"><i class="fa fa-credit-card"></i></span>
                  <span class="checkout-section-title">{{ text_payment_method }}</span>
                </div>
                <div class="checkout-section-body">
                  <div id="payment-methods" class="payment-methods-list">
                    <div class="loading-placeholder">
                      <i class="fa fa-spinner fa-spin"></i> {{ text_loading }}
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}

              {# Order Comment - Unishop2 style #}
              {% if show_comment %}
              <div class="checkout-section checkout-comment">
                <div class="checkout-section-header">
                  <span class="checkout-section-icon"><i class="fa fa-comment"></i></span>
                  <span class="checkout-section-title">{{ text_comments }}</span>
                </div>
                <div class="checkout-section-body">
                  <textarea name="comment" rows="4" class="form-control input-lg" placeholder="{{ entry_comment }}"></textarea>
                </div>
              </div>
              {% endif %}

            </div>

            {# Sidebar with totals #}
            <div class="col-md-4">
              <div class="checkout-sidebar">
                <div class="checkout-section checkout-totals">
                  <div class="checkout-section-header">
                    <span class="checkout-section-icon"><i class="fa fa-shopping-cart"></i></span>
                    <span class="checkout-section-title">Ваш заказ</span>
                  </div>
                  <div class="checkout-section-body">
                    {# Products List #}
                    <div class="checkout-products">
                      {% for product in products %}
                      <div class="checkout-product">
                        <div class="checkout-product-image">
                          <a href="{{ product.href }}"><img src="{{ product.image }}" alt="{{ product.name }}" /></a>
                        </div>
                        <div class="checkout-product-info">
                          <div class="checkout-product-name">
                            <a href="{{ product.href }}">{{ product.name }}</a>
                          </div>
                          {% if product.option %}
                          <div class="checkout-product-options">
                            {% for option in product.option %}
                            <small>{{ option.name }}: {{ option.value }}</small><br/>
                            {% endfor %}
                          </div>
                          {% endif %}
                          <div class="checkout-product-qty">{{ product.quantity }} x {{ product.price }}</div>
                        </div>
                        <div class="checkout-product-total">{{ product.total }}</div>
                      </div>
                      {% endfor %}
                    </div>
                    <hr style="margin: 15px 0; border-color: #eee;">
                    <table class="table table-totals" id="totals-table">
                      <tbody>
                        <tr>
                          <td colspan="2" class="text-center">
                            <i class="fa fa-spinner fa-spin"></i> {{ text_loading }}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                {# Agreement #}
                {% if agree %}
                <div class="checkout-agree">
                  <div class="checkbox custom-checkbox">
                    <label>
                      <input type="checkbox" name="agree" value="1" />
                      <span class="checkbox-icon"></span>
                      <span class="checkbox-text">{{ text_agree }}</span>
                    </label>
                  </div>
                </div>
                {% endif %}

                {# Confirm Button #}
                <div class="checkout-buttons">
                  <button type="button" id="button-confirm" class="btn btn-primary btn-lg btn-block btn-checkout" disabled="disabled">
                    <i class="fa fa-check"></i> {{ button_confirm }}
                  </button>
                </div>
              </div>
            </div>

          </div>
        </form>
      </div>

      {{ content_bottom }}</div>
  </div>
</div>

<script type="text/javascript">
(function($) {
    'use strict';

    var SimpleCheckoutLite = {
        urls: {
            save: '{{ action_save }}',
            shipping: '{{ action_shipping }}',
            payment: '{{ action_payment }}',
            totals: '{{ action_totals }}',
            confirm: '{{ action_confirm }}',
            zone: '{{ action_zone }}'
        },
        shipping_required: {{ shipping_required ? 'true' : 'false' }},
        show_shipping_method: {{ show_shipping_method ? 'true' : 'false' }},
        show_payment_method: {{ show_payment_method ? 'true' : 'false' }},
        require_agree: {{ agree ? 'true' : 'false' }},
        fields: {
            firstname: '{{ fields.firstname }}',
            lastname: '{{ fields.lastname }}',
            email: '{{ fields.email }}',
            telephone: '{{ fields.telephone }}',
            company: '{{ fields.company }}',
            address_1: '{{ fields.address_1 }}',
            address_2: '{{ fields.address_2 }}',
            city: '{{ fields.city }}',
            postcode: '{{ fields.postcode }}',
            country: '{{ fields.country }}',
            zone: '{{ fields.zone }}'
        }
    };

    var SCL = {
        init: function() {
            console.log('Simple Checkout Lite initializing...');
            this.bindEvents();
            this.loadZones();
            this.updateAll();
            this.validateForm();
        },

        bindEvents: function() {
            var self = this;

            // Validate on any input change
            $('#simple-checkout-form').on('input change', 'input, select, textarea', function() {
                self.validateForm();
            });

            $('#input-country').on('change', function() {
                self.loadZones();
                self.updateAll();
            });

            $('#input-zone').on('change', function() {
                self.updateAll();
            });

            $('#input-address-1, #input-city, #input-postcode').on('change', function() {
                self.updateAll();
            });

            $(document).on('change', 'input[name="shipping_method"]', function() {
                self.setShippingMethod($(this).val());
            });

            $(document).on('change', 'input[name="payment_method"]', function() {
                self.setPaymentMethod($(this).val());
            });

            $('#button-confirm').on('click', function() {
                self.confirmOrder();
            });
        },

        loadZones: function() {
            var country_id = $('#input-country').val();
            var zone_id = $('#input-zone').data('zone-id');

            if (!country_id) {
                $('#input-zone').html('<option value="">-- Выберите --</option>');
                return;
            }

            $.ajax({
                url: SimpleCheckoutLite.urls.zone + '&country_id=' + country_id,
                dataType: 'json',
                success: function(json) {
                    var html = '<option value="">-- Выберите --</option>';
                    if (json && json.length > 0) {
                        for (var i = 0; i < json.length; i++) {
                            if (json[i].zone_id == zone_id) {
                                html += '<option value="' + json[i].zone_id + '" selected="selected">' + json[i].name + '</option>';
                            } else {
                                html += '<option value="' + json[i].zone_id + '">' + json[i].name + '</option>';
                            }
                        }
                    }
                    $('#input-zone').html(html);
                },
                error: function(xhr, status, error) {
                    console.error('Zone load error:', error);
                }
            });
        },

        updateAll: function() {
            var self = this;
            console.log('Updating checkout data...');

            this.saveCustomerData(function(result) {
                if (SimpleCheckoutLite.shipping_required && SimpleCheckoutLite.show_shipping_method) {
                    self.loadShippingMethods(function() {
                        if (SimpleCheckoutLite.show_payment_method) {
                            self.loadPaymentMethods();
                        } else {
                            self.loadTotals();
                        }
                    });
                } else if (SimpleCheckoutLite.show_payment_method) {
                    self.loadPaymentMethods();
                } else {
                    self.loadTotals();
                }
            });
        },

        saveCustomerData: function(callback) {
            var formData = $('#simple-checkout-form').serialize();
            console.log('Saving customer data to:', SimpleCheckoutLite.urls.save);
            console.log('Form data:', formData);

            $.ajax({
                url: SimpleCheckoutLite.urls.save,
                type: 'POST',
                data: formData,
                dataType: 'json',
                success: function(json) {
                    console.log('Save response:', json);
                    $('.form-group').removeClass('has-error');
                    $('.text-danger').remove();

                    if (json && json.error) {
                        for (var field in json.error) {
                            var $input = $('#input-' + field.replace(/_/g, '-'));
                            $input.closest('.form-group').addClass('has-error');
                            $input.after('<div class="text-danger">' + json.error[field] + '</div>');
                        }
                    }

                    if (callback) callback(json || {});
                },
                error: function(xhr, status, error) {
                    console.error('Save AJAX error:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                    if (callback) callback({error: true});
                }
            });
        },

        loadShippingMethods: function(callback) {
            var $container = $('#shipping-methods');
            $container.html('<div class="loading-placeholder"><i class="fa fa-spinner fa-spin"></i> Загрузка...</div>');

            $.ajax({
                url: SimpleCheckoutLite.urls.shipping,
                dataType: 'json',
                success: function(json) {
                    console.log('Shipping response:', json);
                    if (json && json.error) {
                        $container.html('<div class="alert alert-warning">' + json.error + '</div>');
                    } else if (json && json.shipping_methods) {
                        var html = '';
                        for (var code in json.shipping_methods) {
                            var shipping = json.shipping_methods[code];
                            if (shipping.error) {
                                html += '<div class="alert alert-warning">' + shipping.error + '</div>';
                            } else {
                                html += '<p><strong>' + shipping.title + '</strong></p>';
                                for (var quote_code in shipping.quote) {
                                    var quote = shipping.quote[quote_code];
                                    var value = code + '.' + quote_code;
                                    var checked = (json.shipping_selected == value) ? ' checked="checked"' : '';
                                    html += '<div class="radio">';
                                    html += '<label>';
                                    html += '<input type="radio" name="shipping_method" value="' + value + '"' + checked + ' />';
                                    html += quote.title + ' - ' + quote.text;
                                    html += '</label>';
                                    html += '</div>';
                                }
                            }
                        }
                        if (html) {
                            $container.html(html);
                        } else {
                            $container.html('<div class="alert alert-info">Нет доступных способов доставки</div>');
                        }
                    } else {
                        $container.html('<div class="alert alert-info">Нет доступных способов доставки</div>');
                    }

                    if (callback) callback(json || {});
                },
                error: function(xhr, status, error) {
                    console.error('Shipping error:', error, xhr.responseText);
                    $container.html('<div class="alert alert-danger">Ошибка загрузки способов доставки</div>');
                    if (callback) callback({error: true});
                }
            });
        },

        loadPaymentMethods: function(callback) {
            var $container = $('#payment-methods');
            if ($container.length === 0) {
                // Payment methods container doesn't exist, just load totals
                this.loadTotals();
                if (callback) callback({});
                return;
            }

            $container.html('<div class="loading-placeholder"><i class="fa fa-spinner fa-spin"></i> Загрузка...</div>');

            var self = this;
            $.ajax({
                url: SimpleCheckoutLite.urls.payment,
                dataType: 'json',
                success: function(json) {
                    console.log('Payment response:', json);
                    if (json && json.error) {
                        $container.html('<div class="alert alert-warning">' + json.error + '</div>');
                    } else if (json && json.payment_methods) {
                        var html = '';
                        for (var code in json.payment_methods) {
                            var payment = json.payment_methods[code];
                            var checked = (json.payment_selected == code) ? ' checked="checked"' : '';
                            html += '<div class="radio">';
                            html += '<label>';
                            html += '<input type="radio" name="payment_method" value="' + code + '"' + checked + ' />';
                            if (payment.image) {
                                html += '<img src="' + payment.image + '" alt="' + payment.title + '" style="max-height: 20px; margin-right: 5px;" /> ';
                            }
                            html += payment.title;
                            html += '</label>';
                            html += '</div>';
                        }
                        if (html) {
                            $container.html(html);
                        } else {
                            $container.html('<div class="alert alert-info">Нет доступных способов оплаты</div>');
                        }
                    } else {
                        $container.html('<div class="alert alert-info">Нет доступных способов оплаты</div>');
                    }

                    // Update totals
                    if (json && json.totals) {
                        var totalsHtml = '';
                        for (var i = 0; i < json.totals.length; i++) {
                            totalsHtml += '<tr>';
                            totalsHtml += '<td class="text-right"><strong>' + json.totals[i].title + ':</strong></td>';
                            totalsHtml += '<td class="text-right">' + json.totals[i].text + '</td>';
                            totalsHtml += '</tr>';
                        }
                        $('#totals-table tbody').html(totalsHtml);
                    }

                    if (callback) callback(json || {});
                },
                error: function(xhr, status, error) {
                    console.error('Payment error:', error, xhr.responseText);
                    $container.html('<div class="alert alert-danger">Ошибка загрузки способов оплаты</div>');
                    if (callback) callback({error: true});
                }
            });
        },

        loadTotals: function(callback) {
            // Load totals separately if payment methods are hidden
            $.ajax({
                url: SimpleCheckoutLite.urls.totals,
                dataType: 'json',
                success: function(json) {
                    console.log('Totals response:', json);
                    if (json && json.totals) {
                        var totalsHtml = '';
                        for (var i = 0; i < json.totals.length; i++) {
                            totalsHtml += '<tr>';
                            totalsHtml += '<td class="text-right"><strong>' + json.totals[i].title + ':</strong></td>';
                            totalsHtml += '<td class="text-right">' + json.totals[i].text + '</td>';
                            totalsHtml += '</tr>';
                        }
                        $('#totals-table tbody').html(totalsHtml);
                    }
                    if (callback) callback(json || {});
                },
                error: function(xhr, status, error) {
                    console.error('Totals error:', error);
                    if (callback) callback({error: true});
                }
            });
        },

        setShippingMethod: function(method) {
            var self = this;

            $.ajax({
                url: 'index.php?route=extension/module/simple_checkout_lite/setShipping',
                type: 'POST',
                data: { shipping_method: method },
                dataType: 'json',
                success: function(json) {
                    if (json && json.success) {
                        self.loadPaymentMethods();
                    }
                }
            });
        },

        setPaymentMethod: function(method) {
            $.ajax({
                url: 'index.php?route=extension/module/simple_checkout_lite/setPayment',
                type: 'POST',
                data: { payment_method: method },
                dataType: 'json',
                success: function(json) {
                    console.log('Payment method set:', method);
                }
            });
        },

        validateForm: function() {
            var isValid = true;
            var fields = SimpleCheckoutLite.fields;

            // Check required text fields
            if (fields.firstname === 'required') {
                var val = $('#input-firstname').val();
                if (!val || val.trim().length < 1 || val.trim().length > 32) isValid = false;
            }

            if (fields.lastname === 'required') {
                var val = $('#input-lastname').val();
                if (!val || val.trim().length < 1 || val.trim().length > 32) isValid = false;
            }

            if (fields.email === 'required') {
                var val = $('#input-email').val();
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!val || !emailRegex.test(val)) isValid = false;
            }

            if (fields.telephone === 'required') {
                var val = $('#input-telephone').val();
                if (!val || val.trim().length < 3 || val.trim().length > 32) isValid = false;
            }

            if (fields.address_1 === 'required') {
                var val = $('#input-address-1').val();
                if (!val || val.trim().length < 3 || val.trim().length > 128) isValid = false;
            }

            if (fields.city === 'required') {
                var val = $('#input-city').val();
                if (!val || val.trim().length < 2 || val.trim().length > 128) isValid = false;
            }

            if (fields.postcode === 'required') {
                var val = $('#input-postcode').val();
                if (!val || val.trim().length < 2 || val.trim().length > 10) isValid = false;
            }

            if (fields.country === 'required') {
                var val = $('#input-country').val();
                if (!val || val === '') isValid = false;
            }

            if (fields.zone === 'required') {
                var val = $('#input-zone').val();
                if (!val || val === '') isValid = false;
            }

            // Check agreement checkbox
            if (SimpleCheckoutLite.require_agree) {
                if (!$('input[name="agree"]').is(':checked')) isValid = false;
            }

            // Enable/disable button
            $('#button-confirm').prop('disabled', !isValid);

            return isValid;
        },

        confirmOrder: function() {
            var self = this;
            var $btn = $('#button-confirm');

            // Double-check validation
            if (!this.validateForm()) {
                return;
            }

            $btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Обработка...');

            this.saveCustomerData(function(saveJson) {
                if (saveJson && saveJson.error && typeof saveJson.error === 'object') {
                    $btn.html('<i class="fa fa-check"></i> {{ button_confirm }}');
                    self.validateForm();
                    return;
                }

                var formData = $('#simple-checkout-form').serialize();

                $.ajax({
                    url: SimpleCheckoutLite.urls.confirm,
                    type: 'POST',
                    data: formData,
                    dataType: 'json',
                    success: function(json) {
                        if (json && json.redirect) {
                            location = json.redirect;
                        } else if (json && json.error) {
                            alert(json.error);
                            $btn.html('<i class="fa fa-check"></i> {{ button_confirm }}');
                            self.validateForm();
                        } else {
                            $btn.html('<i class="fa fa-check"></i> {{ button_confirm }}');
                            self.validateForm();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Confirm error:', error, xhr.responseText);
                        alert('Произошла ошибка. Попробуйте еще раз.');
                        $btn.html('<i class="fa fa-check"></i> {{ button_confirm }}');
                        self.validateForm();
                    }
                });
            });
        }
    };

    // Initialize when DOM is ready
    $(document).ready(function() {
        SCL.init();
    });

})(jQuery);
</script>
{{ footer }}
